{% extends "base.html" %}
{% set title = "Net Income" %}

{% block content %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h1 class="h3 mb-0">Net Income</h1>
      <div class="text-muted">
        Estimate your net income from gross annual income using federal + selected state income tax schedules.
      </div>
    </div>

    <!-- Pencil icon to edit latest saved entry -->
    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editLatestModal" title="Edit latest net income">
      <i class="bi bi-pencil"></i>
    </button>
  </div>

  <div class="row g-3">
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5">1) Gross â†’ Estimated Net (Taxes)</h2>

          <form id="estimateForm" class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Gross annual income</label>
              <input class="form-control" name="gross_annual" type="number" min="0" step="0.01" placeholder="e.g., 85000" required />
            </div>

            <div class="col-md-6">
              <label class="form-label">Filing status</label>
              <select class="form-select" name="filing_status">
                <option value="single" selected>Single</option>
                <option value="mfj">Married Filing Jointly</option>
                <option value="hoh">Head of Household</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">State</label>
              <select class="form-select" name="state">
                {% for code, name in states %}
                  <option value="{{ code }}">{{ name }}</option>
                {% endfor %}
              </select>
              <div class="form-text">
                Demo states included; extendable to additional states by adding bracket tables.
              </div>
            </div>

            <div class="col-12 mt-2">
              <button class="btn btn-primary" type="submit">Estimate</button>
            </div>
          </form>

          <hr class="my-4" />

          <div id="estimateResult" class="d-none">
            <h3 class="h6">Estimate result</h3>
            <div class="row g-2">
              <div class="col-md-6">
                <div class="p-3 bg-light border rounded">
                  <div class="text-muted small">Federal tax</div>
                  <div class="fs-5" id="fedTax">$0</div>
                  <div class="text-muted small mt-1">Standard deduction used: <span id="fedDed">$0</span></div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="p-3 bg-light border rounded">
                  <div class="text-muted small">State tax</div>
                  <div class="fs-5" id="stateTax">$0</div>
                  <div class="text-muted small mt-1">State: <span id="stateCode">--</span></div>
                </div>
              </div>
              <div class="col-12">
                <div class="p-3 border rounded">
                  <div class="text-muted small">Estimated net annual income</div>
                  <div class="fs-4" id="netAnnual">$0</div>
                </div>
              </div>
              <div class="col-12">
                <div class="alert alert-warning mb-0">
                  This is a simplified estimate and may differ from actual withholding or final tax liability.
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5">2) Save your net income</h2>

          <form id="saveNetForm" class="row g-2">
            <div class="col-12">
              <label class="form-label">Label</label>
              <input class="form-control" name="label" placeholder="e.g., Paycheck take-home" />
            </div>

            <div class="col-12">
              <label class="form-label">Net income amount</label>
              <input class="form-control" name="net_amount" type="number" min="0" step="0.01" required />
            </div>

            <div class="col-12">
              <label class="form-label">Frequency</label>
              <select class="form-select" name="frequency">
                <option value="weekly">Weekly</option>
                <option value="bi-weekly">Bi-weekly</option>
                <option value="monthly" selected>Monthly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>

            <div class="col-12 mt-2">
              <button class="btn btn-success" type="submit">Save</button>
            </div>
          </form>

          <hr class="my-4" />

          <h3 class="h6">Latest saved entry</h3>
          {% if last_entry %}
            <div class="text-muted small">{{ last_entry.ts }}</div>
            <div class="mt-2">
              <div><strong>{{ last_entry.label }}</strong></div>
              <div>{{ "%.2f"|format(last_entry.net_amount) }} ({{ last_entry.frequency }})</div>
              <div class="text-muted small mt-1">
                Annual equivalent: {{ "%.2f"|format(last_entry.net_annual_equivalent) }}
              </div>
            </div>
          {% else %}
            <div class="text-muted">No saved net income yet.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Latest Modal -->
  <div class="modal fade" id="editLatestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit latest net income</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editLatestForm" class="row g-2">
            <div class="col-12">
              <label class="form-label">Label</label>
              <input class="form-control" name="label" value="{{ last_entry.label if last_entry else '' }}" />
            </div>

            <div class="col-12">
              <label class="form-label">Net income amount</label>
              <input class="form-control" name="net_amount" type="number" min="0" step="0.01" value="{{ last_entry.net_amount if last_entry else '' }}" />
            </div>

            <div class="col-12">
              <label class="form-label">Frequency</label>
              <select class="form-select" name="frequency">
                {% set f = (last_entry.frequency if last_entry else "monthly") %}
                <option value="weekly" {{ "selected" if f=="weekly" else "" }}>Weekly</option>
                <option value="bi-weekly" {{ "selected" if f in ["bi-weekly","biweekly"] else "" }}>Bi-weekly</option>
                <option value="monthly" {{ "selected" if f=="monthly" else "" }}>Monthly</option>
                <option value="yearly" {{ "selected" if f=="yearly" else "" }}>Yearly</option>
              </select>
            </div>

            <div class="col-12 mt-2">
              <button class="btn btn-primary" type="submit">Save changes</button>
            </div>
          </form>

          <div id="editError" class="alert alert-danger d-none mt-3"></div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}
